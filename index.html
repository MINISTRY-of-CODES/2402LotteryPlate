<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lottery</title>

    <link href="static/css/zzsc.css" rel="stylesheet" type="text/css" />
    <link href="static/css/pop-ups.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/mdui@2.0.3/mdui.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .container {
        margin: 0 auto;
      }

      .content {
        position: absolute;
        width: 100%;
        height: auto;
        margin: 0px auto;
        margin-top: 58%;
      }
    </style>
  </head>

  <body>
    <img
      src="static/picture/game-bg-zh.png"
      alt="background"
      class="bg"
      class="zh"
      id="zh"
    />
    <img
      src="static/picture/game-bg-en.png"
      alt="background"
      class="bg"
      class="en"
      id="en"
      style="display: none"
    />

      <mdui-icon onclick="switchLanguage()"
        name="translate"
        slot="icon"
        style="
          position: fixed;
          font-size: 30px;
          margin-top: 15px;
          margin-right: 15px;
          left: 85%;
          color: rgb(235, 248, 253);
        "
      ></mdui-icon>

    <div class="content" style="margin-top: 60%">
      <div class="banner">
        <!--抽奖转盘-->
        <div
          class="turnplate"
          style="
            background-image: url(static/image/turnplate-bg.png);
            background-size: 100% 100%;
          "
        >
          <canvas
            class="item"
            id="wheelcanvas"
            width="422px"
            height="422px"
          ></canvas>
          <img class="pointer" src="static/picture/turnplate-pointer.png" />
        </div>

        <!--抽奖次数&幸运值-->
        <mdui-list
          style="
            margin-top: 10%;
            background-color: #fde3cd;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-item>
            <p class="zh" style="font-weight: bold">抽奖机会</p>
            <p class="en" style="font-weight: bold">Chance</p>
            <p
              slot="end-icon"
              id="chanceNum"
              style="font-weight: bold; font-size: large"
            ></p>
          </mdui-list-item>
          <mdui-list-item>
            <p style="font-weight: bold">幸运值</p>
            <p
              slot="end-icon"
              id="luckyNum"
              style="font-weight: bold; font-size: large"
            ></p>
          </mdui-list-item>
        </mdui-list>

        <!--查看详细抽奖规则&中奖查询-->
        <div style="justify-content: center">
          <mdui-button
            style="margin-top: 5%; left: 10%"
            onclick="switchRuleDetail()"
            >抽奖规则</mdui-button
          >
          <mdui-button style="margin-top: 5%; left: 17%">中奖查询</mdui-button>
        </div>

        <!--获得抽奖机会-->
        <mdui-list
          style="
            margin-top: 2%;
            background-color: #fae7d6;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-subheader style="font-size: larger; font-weight: bold"
            >获得抽奖机会</mdui-list-subheader
          >
          <mdui-list-item>
            <p style="font-weight: lighter; font-size: small">1、安装软件</p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChance(0)"
            >
              <p id="rule0Num">0/1</p>
            </mdui-button>
          </mdui-list-item>
          <mdui-list-item>
            <p style="font-weight: lighter; font-size: small">
              2、邀请4位同学注册
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChance(1)"
            >
              <p id="rule1Num">0/3</p>
            </mdui-button>
          </mdui-list-item>
          <mdui-list-item>
            <p style="font-weight: lighter; font-size: small">
              3、参与食堂评价
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChance(2)"
            >
              <p id="rule2Num">0/1</p>
            </mdui-button>
          </mdui-list-item>
        </mdui-list>

        <!--中奖记录展示-->
        <mdui-list
          style="
            margin-top: 5%;
            background-color: #fae7d6;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-subheader style="font-size: larger; font-weight: bold"
            >中奖记录</mdui-list-subheader
          >
          <mdui-list-item> </mdui-list-item>
        </mdui-list>
      </div>
    </div>

    <!-- 抽奖规则弹窗 -->
    <div id="myRuleDetail" class="ruleDetail">
      <h2>抽奖规则：</h2>
      <p>1、安装软件获得1次抽奖机会</p>
      <p>
        2、每邀请4位同学安装并注册软件，获得1次抽奖机会（最多可获得3次抽奖机会）
      </p>
      <p>3、参与食堂打分可获得1次抽奖机会（最多可获得1次抽奖机会）</p>
      <h2 style="margin-top: 10px">兑奖规则：</h2>
      <p style="margin-bottom: 5px">
        消耗抽奖次数进行抽奖后，若中奖，则会产生中奖记录并保存。
      </p>
      <p>用户前往活动摊位凭中奖记录兑换相应奖品。</p>
      <mdui-button
        onclick="switchRuleDetail()"
        style="margin-top: 10px; left: 70%; height: 35px"
        >确定</mdui-button
      >
    </div>

    <!-- 语言选择弹窗 -->
    <div id="myModal" class="modal">
      <p style="margin-bottom: 15px; font-weight: bold">
        Please select language:
      </p>
      <mdui-button
        class="btn"
        onclick="selectLanguage('en')"
        style="width: 40%; margin: 0 10px"
        >English</mdui-button
      >
      <mdui-button class="btn" onclick="selectLanguage('zh')" style="width: 40%"
        >鬃纹</mdui-button
      >
    </div>

    <script src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/awardRotate.js"></script>
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <script type="text/javascript">

      // 获取token和language
      const url = new URL(window.location.href);
      const token = url.searchParams.get("token");
      const lang = url.searchParams.get("lang");

      // 自动选择语言
      $(document).ready(function () {
        if (lang.includes("en")) {
          document.getElementsByClassName("zh").style.display = "none";
          document.getElementsByClassName("en").style.display = "block";
        } else if (lang.includes("zh")) {
          document.getElementsByClassName("zh").style.display = "block";
          document.getElementsByClassName("en").style.display = "none";
        }
      });

      function selectLanguage(choseLang) {
        if (choseLang == "en") {
          document.getElementsByClassName("zh").style.display = "none";
          document.getElementsByClassName("en").style.display = "block";
        } else {
          document.getElementsByClassName("zh").style.display = "block";
          document.getElementsByClassName("en").style.display = "none";
        }
        console.log(choseLang);
        document.getElementById("myModal").style.display = "none";
      }

      // 显示/关闭抽奖规则弹窗
      function switchRuleDetail() {
        if (document.getElementById("myRuleDetail").style.display == "block") {
          document.getElementById("myRuleDetail").style.display = "none";
        } else {
          document.getElementById("myRuleDetail").style.display = "block";
        }
      }
      // 显示语言选择弹窗
      function switchLanguage() {
        document.getElementById("myModal").style.display = "block";
      }

      var turnplate = {
        restaraunts: [], //大转盘奖品名称
        colors: [], //大转盘奖品区块对应背景颜色
        outsideRadius: 192, //大转盘外圆的半径
        textRadius: 155, //大转盘奖品位置距离圆心的距离
        insideRadius: 68, //大转盘内圆的半径
        startAngle: 0, //开始角
        bRotate: false, //false:停止;ture:旋转
      };

      var chanceNum = 3; //抽奖次数
      var luckyNum = 15; //幸运值=已抽奖次数*15

      // 获取要展示变量值的元素
      var chanceNumElement = document.getElementById("chanceNum");
      var luckyNumElement = document.getElementById("luckyNum");
      // 将变量值显示在页面上
      chanceNumElement.textContent = chanceNum;
      luckyNumElement.textContent = luckyNum;

      function addChance(ruleNo) {
        // 点击按钮获得抽奖机会
        // TODO:
      }

      function getLotteryResult() {
        // 点击按钮查询(刷新)中奖记录
        // TODO:
      }

      $(document).ready(function () {
        // 打开页面时加载当前奖池

        //动态添加大转盘的奖品与奖品区域背景颜色
        turnplate.restaraunts = [
          "20积分",
          "足疗机",
          "20积分",
          "保温杯",
          "20积分",
          "手持式电熨斗",
        ];
        turnplate.colors = [
          "#008080",
          "#209B87",
          "#4DB686",
          "#80CF7F",
          "#B9E576",
          "#F9F871",
        ];
        var rotateTimeOut = function () {
          $("#wheelcanvas").rotate({
            angle: 0,
            animateTo: 2160,
            duration: 8000,
            callback: function () {
              alert("网络超时，请检查您的网络设置！");
            },
          });
        };

        //旋转转盘 item:奖品位置; txt：提示语;
        var rotateFn = function (item, txt) {
          var angles =
            item * (360 / turnplate.restaraunts.length) -
            360 / (turnplate.restaraunts.length * 2);
          if (angles < 270) {
            angles = 270 - angles;
          } else {
            angles = 360 - angles + 270;
          }
          $("#wheelcanvas").stopRotate();
          $("#wheelcanvas").rotate({
            angle: 0,
            animateTo: angles + 14400, //旋转角度
            duration: 8020, //旋转动画时间
            callback: function () {
              //中奖提示
              alert("获得奖品：" + txt);
              turnplate.bRotate = !turnplate.bRotate;
            },
          });
        };

        $(".pointer").click(function () {
          //指针点击事件
          if (turnplate.bRotate) return; //过滤转盘正在旋转中发生的点击事件
          turnplate.bRotate = !turnplate.bRotate;
          //获取随机数(奖品个数范围内)
          var item = rnd(1, turnplate.restaraunts.length);
          //奖品数量等于10,指针落在对应奖品区域的中心角度[252, 216, 180, 144, 108, 72, 36, 360, 324, 288]
          rotateFn(item, turnplate.restaraunts[item - 1]);
          console.log(item);
        });
      });

      function rnd(n, m) {
        n = 1; //最小随机数
        m = 100; //最大随机数（概率范围最大值）
        //最大数数不超过最大随机数
        var ransluck = [50, 60, 65, 70, 75, 80, 85, 90, 95, 100]; //概率为比自己小的第一个数之间的差
        var randoms = Math.floor(Math.random() * (m - n + 1) + n);
        if (randoms <= ransluck[0]) {
          var random = 1;
        } else if (randoms <= ransluck[1]) {
          var random = 2;
        } else if (randoms <= ransluck[2]) {
          var random = 3;
        } else if (randoms <= ransluck[3]) {
          var random = 4;
        } else if (randoms <= ransluck[4]) {
          var random = 5;
        } else if (randoms <= ransluck[5]) {
          var random = 6;
        } else if (randoms <= ransluck[6]) {
          var random = 7;
        } else if (randoms <= ransluck[7]) {
          var random = 8;
        } else if (randoms <= ransluck[8]) {
          var random = 9;
        } else if (randoms <= ransluck[9]) {
          var random = 10;
        }
        //alert(randoms);
        //alert(random);
        return random;
      }

      //页面所有元素加载完毕后执行drawRouletteWheel()方法对转盘进行渲染
      window.onload = function () {
        drawRouletteWheel();
      };

      function drawRouletteWheel() {
        var canvas = document.getElementById("wheelcanvas");
        if (canvas.getContext) {
          //根据奖品个数计算圆周角度
          var arc = Math.PI / (turnplate.restaraunts.length / 2);
          var ctx = canvas.getContext("2d");
          //在给定矩形内清空一个矩形
          ctx.clearRect(0, 0, 422, 422);
          //strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式
          ctx.strokeStyle = "#FFBE04";
          //font 属性设置或返回画布上文本内容的当前字体属性
          ctx.font = "16px Microsoft YaHei";
          for (var i = 0; i < turnplate.restaraunts.length; i++) {
            var angle = turnplate.startAngle + i * arc;
            ctx.fillStyle = turnplate.colors[i];
            ctx.beginPath();
            //arc(x,y,r,起始角,结束角,绘制方向) 方法创建弧/曲线（用于创建圆或部分圆）
            ctx.arc(
              // 绘制外圈圆弧
              211,
              211,
              turnplate.outsideRadius,
              angle,
              angle + arc,
              false
            );
            ctx.arc(211, 211, turnplate.insideRadius, angle + arc, angle, true); // 绘制内圈圆弧
            ctx.stroke();
            ctx.fill();
            //锁画布(为了保存之前的画布状态)
            ctx.save();

            //----绘制奖品开始----
            ctx.fillStyle = "#E5302F";
            var text = turnplate.restaraunts[i];
            var line_height = 17;
            //translate方法重新映射画布上的 (0,0) 位置
            ctx.translate(
              211 + Math.cos(angle + arc / 2) * turnplate.textRadius,
              211 + Math.sin(angle + arc / 2) * turnplate.textRadius
            );

            //rotate方法旋转当前的绘图
            ctx.rotate(angle + arc / 2 + Math.PI / 2);

            /** 下面代码根据奖品类型、奖品名称长度渲染不同效果，如字体、颜色、图片效果。(具体根据实际情况改变) **/
            if (text.indexOf("M") > 0) {
              //流量包
              var texts = text.split("M");
              for (var j = 0; j < texts.length; j++) {
                ctx.font =
                  j == 0 ? "bold 20px Microsoft YaHei" : "16px Microsoft YaHei";
                if (j == 0) {
                  ctx.fillText(
                    texts[j] + "M",
                    -ctx.measureText(texts[j] + "M").width / 2,
                    j * line_height
                  );
                } else {
                  ctx.fillText(
                    texts[j],
                    -ctx.measureText(texts[j]).width / 2,
                    j * line_height
                  );
                }
              }
            } else if (text.indexOf("M") == -1 && text.length > 6) {
              //奖品名称长度超过一定范围
              text = text.substring(0, 6) + "||" + text.substring(6);
              var texts = text.split("||");
              for (var j = 0; j < texts.length; j++) {
                ctx.fillText(
                  texts[j],
                  -ctx.measureText(texts[j]).width / 2,
                  j * line_height
                );
              }
            } else {
              //在画布上绘制填色的文本。文本的默认颜色是黑色
              //measureText()方法返回包含一个对象，该对象包含以像素计的指定字体宽度
              ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
            }

            //添加对应图标
            if (text.indexOf("分") > 0) {
              var img = document.getElementById("fen-img");
              img.onload = function () {
                ctx.drawImage(img, -15, 10);
              };
              ctx.drawImage(img, -15, 10);
            } else if (text.indexOf("足疗") >= 0) {
              var img = document.getElementById("zuliao-img");
              img.onload = function () {
                ctx.drawImage(img, -15, 10);
              };
              ctx.drawImage(img, -15, 10);
            } else if (text.indexOf("保温") >= 0) {
              var img = document.getElementById("baowen-img");
              img.onload = function () {
                ctx.drawImage(img, -15, 10);
              };
              ctx.drawImage(img, -15, 10);
            } else if (text.indexOf("电熨斗") >= 0) {
              var img = document.getElementById("yundou-img");
              img.onload = function () {
                ctx.drawImage(img, -15, 10);
              };
              ctx.drawImage(img, -15, 10);
            } else if (text.indexOf("橄榄") >= 0) {
              var img = document.getElementById("ganlan-img");
              img.onload = function () {
                ctx.drawImage(img, -15, 10);
              };
              ctx.drawImage(img, -15, 10);
            } else if (text.indexOf("雨伞") >= 0) {
              var img = document.getElementById("yusan-img");
              img.onload = function () {
                ctx.drawImage(img, -15, 10);
              };
              ctx.drawImage(img, -15, 10);
            }

            //把当前画布返回（调整）到上一个save()状态之前
            ctx.restore();
            //----绘制奖品结束----
          }
        }
      }
    </script>
  </body>
</html>
