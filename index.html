<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lottery</title>

    <link href="static/css/zzsc.css?version=1.0.0" rel="stylesheet" type="text/css" />
    <link href="static/css/pop-ups.css?version=1.0.0" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/mdui@2.0.3/mdui.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .container {
        margin: 0 auto;
      }

      .content {
        position: absolute;
        width: 100%;
        height: auto;
        margin: 0px auto;
        margin-top: 58%;
      }
    </style>
  </head>

  <body>
    <img
      src="static/picture/game-bg-zh.png"
      alt="background"
      class="zh bg"
    />
    <img
      src="static/picture/game-bg-en.png"
      alt="background"
      class="en bg"
    />

      <mdui-icon onclick="switchLanguagePopUp()"
        name="language"
        style="
          position: fixed;
          font-size: 30px;
          margin-top: 35px;
          margin-right: 15px;
          left: 85%;
          color: rgb(235, 248, 253);
        "
      ></mdui-icon>

    <div class="content" style="margin-top: 60%">
      <div class="banner">
        <!--æŠ½å¥–è½¬ç›˜-->
        <div
          class="turnplate"
          style="
            background-image: url(static/image/turnplate-bg.png);
            background-size: 100% 100%;
          "
        >
          <canvas
            class="item"
            id="wheelcanvas"
            width="422px"
            height="422px"
          ></canvas>
          <img class="pointer" src="static/picture/turnplate-pointer.png" />
        </div>
        <mdui-icon name='info' style="font-size: 26px; color: rgb(104, 15, 219);" onclick="switchProbabilityTable()"> </mdui-icon>
        <!--æŠ½å¥–æ¬¡æ•°&å¹¸è¿å€¼-->
        <mdui-list
          style="
            margin-top: 2%;
            background-color: #fde3cd;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-item>
            <p class="zh" style="font-weight: bold">æŠ½å¥–æœºä¼š</p>
            <p class="en" style="font-weight: bold">Chance</p>
            <p
              slot="end-icon"
              id="chanceNum"
              style="font-weight: bold; font-size: large"
            ></p>
          </mdui-list-item>
          <mdui-divider></mdui-divider>
          <mdui-list-item>
            <p class="zh" style="font-weight: bold">å¹¸è¿å€¼</p>
            <p class="en" style="font-weight: bold">Lucky Level</p>
            <p
              slot="end-icon"
              id="luckyNum"
              style="font-weight: bold; font-size: large"
            ></p>
          </mdui-list-item>
        </mdui-list>

        <!--æŸ¥çœ‹è¯¦ç»†æŠ½å¥–è§„åˆ™&ä¸­å¥–æ¦‚ç‡&ä¸­å¥–æŸ¥è¯¢-->
        <div style="justify-content: center">
          <mdui-button
            style="margin-top: 5%; left: 10%; width: 100px;"
            onclick="switchRuleDetail()"
            >
            <p class="zh">æŠ½å¥–è§„åˆ™</p>
            <p class="en">Rules</p>
          </mdui-button>
          <mdui-button onclick="getLotteryResult()" style="margin-top: 5%; left: 17%; width: 100px;">
            <p class="zh">ä¸­å¥–æŸ¥è¯¢</p>
            <p class="en">Result Query</p>
          </mdui-button>
        </div>

        <!--è·å¾—æŠ½å¥–æœºä¼š-->
        <mdui-list
          style="
            margin-top: 2%;
            background-color: #fae7d6;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-subheader style="font-size: larger; font-weight: bold">
            <p class="zh">è·å¾—æŠ½å¥–æœºä¼š</p>
            <p class="en">Get Chance</p>
          </mdui-list-subheader
          >
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">1ã€å®‰è£…è½¯ä»¶</p>
            <p class="en" style="font-weight: lighter; font-size: small">1ã€Install Xplorer</p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChancebyRule0()"
            >
              <p id="rule0Num"></p>
            </mdui-button>
          </mdui-list-item>
          <mdui-divider></mdui-divider>
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">
              2ã€åˆ°è¾¾ä¸–ç•Œæœ€é«˜æ‘Šä½~
            </p>
            <p class="en" style="font-weight: lighter; font-size: small">
              2ã€ Come to the booth
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="showTokenCode()"
            >
              <p id="rule3Num"></p>
            </mdui-button>
          </mdui-list-item>
          <mdui-divider></mdui-divider>
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">
              3ã€é‚€è¯·4ä½åŒå­¦æ³¨å†Œ
            </p>
            <p class="en" style="font-weight: lighter; font-size: small">
              4ã€Invite 4 friends to register
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChanceRule1()"
            >
              <p id="rule1Num"></p>
            </mdui-button>
          </mdui-list-item>
          <mdui-divider></mdui-divider>
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">
              4ã€å‚ä¸é£Ÿå ‚è¯„ä»·
            </p>
            <p class="en" style="font-weight: lighter; font-size: small">
              4ã€ Participate in Canteen Vote
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChanceRule2()"
            >
              <p id="rule2Num"></p>
            </mdui-button>
          </mdui-list-item>
          <mdui-divider></mdui-divider>
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">
              5ã€æå‡ºå»ºè®®
            </p>
            <p class="en" style="font-weight: lighter; font-size: small">
              5ã€Leave advice
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="showTokenCode()"
            >
              <p id="rule4Num"></p>
            </mdui-button>
          </mdui-list-item>
        </mdui-list>

        <!--ä¸­å¥–è®°å½•å±•ç¤º-->
        <mdui-list 
          style="
            margin-top: 5%;
            background-color: #fae7d6;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-subheader style="font-size: larger; font-weight: bold">
            <p class="zh">
              <span>ä¸­å¥–è®°å½•</span>
              <span style="font-size: 12px; font-weight: lighter;">ç‚¹å‡»å±•ç¤ºå…‘å¥–äºŒç»´ç </span>
            </p>
            <p class="en">
              <span>Result</span>
              <span style="font-size: 12px; font-weight: lighter;">Click to display the QR code</span>
            </p>
          </mdui-list-subheader>
          <div id="resultList"></div>
        </mdui-list>
      </div>
    </div>

    <!-- æŠ½å¥–è§„åˆ™å¼¹çª— -->
    <div id="myRuleDetail" class="ruleDetail">
      <div class="zh">
        <h2>æŠ½å¥–è§„åˆ™ï¼š</h2>
        <p>1ã€å®‰è£…è½¯ä»¶è·å¾—1æ¬¡æŠ½å¥–æœºä¼š</p>
        <p>
          2ã€æ¯é‚€è¯·4ä½åŒå­¦å®‰è£…å¹¶æ³¨å†Œè½¯ä»¶ï¼Œè·å¾—1æ¬¡æŠ½å¥–æœºä¼šï¼ˆæœ€å¤šå¯è·å¾—3æ¬¡æŠ½å¥–æœºä¼šï¼‰
        </p>
        <p>3ã€å‚ä¸é£Ÿå ‚æ‰“åˆ†å¯è·å¾—1æ¬¡æŠ½å¥–æœºä¼šï¼ˆæœ€å¤šå¯è·å¾—1æ¬¡æŠ½å¥–æœºä¼šï¼‰</p>
        <p style="margin-top: 5px;">*ï¼šè‹¥æŠ½å¥–ä½†æ˜¯æ²¡æœ‰ä¸­å¥–ï¼Œåˆ™å°†ç§¯ç´¯å¹¸è¿å€¼æå‡ä¸‹æ¬¡æŠ½å¥–çš„ä¸­å¥–æ¦‚ç‡ï¼Œå¹¸è¿å€¼å°†ä¼šåœ¨ä¸‹æ¬¡ä¸­å¥–åé‡ç½®</p>
        <h2 style="margin-top: 10px">å…‘å¥–è§„åˆ™ï¼š</h2>
        <p style="margin-bottom: 5px">
          æ¶ˆè€—æŠ½å¥–æ¬¡æ•°è¿›è¡ŒæŠ½å¥–åï¼Œè‹¥ä¸­å¥–ï¼Œåˆ™ä¼šäº§ç”Ÿä¸­å¥–è®°å½•å¹¶ä¿å­˜ã€‚
        </p>
        <p>ç”¨æˆ·å‰å¾€æ´»åŠ¨æ‘Šä½å‡­ä¸­å¥–è®°å½•äºŒç»´ç å…‘æ¢ç›¸åº”å¥–å“ã€‚</p>
        <p style="margin-top: 20px; font-weight: lighter; font-size: 12px;">æ³¨ï¼šæœ¬æ´»åŠ¨ä¸è‹¹æœå…¬å¸æ— å…³</p>
      </div>
      <div class="en">
        <h2>Rulesï¼š</h2>
        <p>1ã€Install Xplorer and get 1 lucky draw chance</p>
        <p>
          2ã€Every 4 students you invite to install and register Xplorer will get 1 lucky draw chance (Maximum 3 lucky draw chances)
        </p>
        <p>3ã€Participate in Canteen Vote to get 1 lucky draw chance (Maximum 1 lucky draw chance)</p>
        <p style="margin-top: 5px;">
          *ï¼šIf you draw but do not win, the Lucky Level will be accumulated to increase the probability of winning the next draw. The Lucky Level will be reset after the next winning.
        </p>
        <h2 style="margin-top: 10px">Prize redemption rulesï¼š</h2>
        <p style="margin-bottom: 5px">
          After consuming the chances of lottery draws, if you win, a winning record will be generated and saved.
        </p>
        <p>Users go to the event booth to redeem corresponding prizes based on the QR codes of winning records.</p>
        <p style="margin-top: 20px; font-weight: lighter; font-size: 12px;">
          Note: This event has nothing to do with Apple Inc.
        </p>
      </div>
      <mdui-button onclick="switchRuleDetail()" style="margin-top: 10px; left: 65%; height: 35px">
        <p class="zh">ğŸ’¡æ‡‚å•¦ !</p>
        <p class="en">ğŸ’¡Get it !</p>
      </mdui-button>
    </div>

    <!--å¥–å“æ¦‚ç‡è¡¨æ ¼å¼¹çª—-->
    <div id="myProbabilityTable" class="probabilityTable">
      <table>
        <tr>
          <th>Extraction Times</th>
          <th>First Extraction</th>
          <th>Second Extraction</th>
          <th>Third Extraction</th>
          <th>Fourth Extraction</th>
          <th>Fifth Extraction</th>
        </tr>
        <tr>
          <td>Under the Big Tree</td>
          <td>2.00%</td>
          <td>10.00%</td>
          <td>20.00%</td>
          <td>20.00%</td>
          <td>20.00%</td>
        </tr>
        <tr>
          <td>Penang</td>
          <td>8.00%</td>
          <td>18.00%</td>
          <td>25.00%</td>
          <td>20.00%</td>
          <td>20.00%</td>
        </tr>
        <tr>
          <td>Postcard</td>
          <td>3.00%</td>
          <td>8.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Red Envelope</td>
          <td>1.00%</td>
          <td>5.00%</td>
          <td>8.00%</td>
          <td>9.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Bookmark</td>
          <td>2.00%</td>
          <td>5.00%</td>
          <td>8.00%</td>
          <td>9.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Envelope</td>
          <td>2.00%</td>
          <td>5.00%</td>
          <td>8.00%</td>
          <td>9.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Total Probability</td>
          <td>18.00%</td>
          <td>51.00%</td>
          <td>79.00%</td>
          <td>77.00%</td>
          <td>80.00%</td>
        </tr>
      </table>
      <mdui-button onclick="switchProbabilityTable()" style="margin-top: 10px; left: 65%; height: 35px; position: sticky;">
        <p class="zh">ğŸ’¡æ‡‚å•¦ !</p>
        <p class="en">ğŸ’¡Get it !</p>
      </mdui-button>
    </div>

    <!-- è¯­è¨€é€‰æ‹©å¼¹çª— -->
    <div id="myModal" class="modal">
      <p style="margin-bottom: 15px; font-weight: bold">
        Please select language:
      </p>
      <mdui-button
        class="btn"
        onclick="selectLanguage('en')"
        style="width: 40%; margin: 0 10px"
        >English</mdui-button
      >
      <mdui-button class="btn" onclick="selectLanguage('zh')" style="width: 40%"
        >é¬ƒçº¹</mdui-button
      >
    </div>

    <!--å…‘å¥–äºŒç»´ç å¼¹çª—-->
    <div id="myQRCode" class="QRCode">
      <p id="codeName" style="font-weight: bold; font-size: 16px; margin-bottom: 10px; text-align: center;"></p>
      <div id="codeArea">
        <div id="qrcode" style="justify-content: center; display: grid;"></div>
      </div>
      <mdui-button onclick="closeQrcode()" style="margin-top: 10px; height: 35px">
        <p class="zh">ğŸ¥³å¥½å•¦ !</p>
        <p class="en">ğŸ¥³Finish !</p>
      </mdui-button>
    </div>

    <!--è·å–æŠ½å¥–æœºä¼šå¼¹çª—ï¼ˆTokenäºŒç»´ç å¼¹çª—ï¼‰-->
    <div id="myTokenQR" class="tokenQR">
      <p id="tokenCodeBanner" style="font-weight: bold; font-size: 16px; margin-bottom: 10px; text-align: center;"> 
        <span class="zh">è¯·å‘æ‘Šä½å·¥ä½œäººå‘˜å‡ºç¤ºäºŒç»´ç </span>
        <span class="en">Please show the QR code to staff</span>
      </p>
      <div id="tokenCodeArea">
        <div id="tokenCode" style="justify-content: center; display: grid;"></div>
      </div>
      <mdui-button onclick="closeTokenCode()" style="margin-top: 10px; height: 35px">
        <p class="zh">ğŸ¥³å¥½å•¦ ! åˆ·æ–°æŠ½å¥–æœºä¼š!</p>
        <p class="en">ğŸ¥³Finish !</p>
      </mdui-button>
    </div>
    
    <script src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/awardRotate.js"></script>
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script type="text/javascript">

      // =====================ç½‘é¡µåˆå§‹åŒ–=====================
      // æ‹¦æˆªéæ³•è®¿é—®ï¼Œè·å–tokenå’Œlanguage
      const url = new URL(window.location.href);
      // if (!(url.href.includes("token") && url.href.includes("lang"))) { // éæ³•è®¿é—®åˆ™é‡å®šå‘è‡³å®˜ç½‘
      //   window.location.href = "https://www.mocd.cc/";
      // }
      const token = url.searchParams.get("token");
      var lang = url.searchParams.get("lang");

      const prefix = (window.location.href.includes("://localhost") || window.location.href.includes("/2402"))
              ? "http://localhost:8080" : "https://api.xmum.app";

      // =====================å¤šè¯­è¨€è°ƒèŠ‚=====================
      // è¯­è¨€è°ƒæ•´å‡½æ•°
      function switchLanguage() {
        if (lang.includes("en")) {
          var enElements = document.getElementsByClassName("en");
          var zhElements = document.getElementsByClassName("zh");
          for (var i = 0; i < enElements.length; i++) {
            enElements[i].style.display = "block";
            zhElements[i].style.display = "none";
          }
        } else if (lang.includes("zh")) {
          var enElements = document.getElementsByClassName("en");
          var zhElements = document.getElementsByClassName("zh");
          for (var i = 0; i < enElements.length; i++) {
            zhElements[i].style.display = "block";
            enElements[i].style.display = "none";
          }
        }
      }
      // è‡ªåŠ¨é€‰æ‹©è¯­è¨€
      $(document).ready(function () {
        switchLanguage();
      });
      // è¯­è¨€é€‰æ‹©æŒ‰é’®
      function selectLanguage(choseLang) {
        lang = choseLang;
        switchLanguage();
        document.getElementById("myModal").style.display = "none";
      }

      // =====================å¼¹çª—æ§åˆ¶=====================
      // æŠ½å¥–è§„åˆ™å¼¹çª—
      function switchRuleDetail() {
        if (document.getElementById("myRuleDetail").style.display == "block") {
          document.getElementById("myRuleDetail").style.display = "none";
        } else {
          document.getElementById("myRuleDetail").style.display = "block";
        }
      }
      // è¯­è¨€é€‰æ‹©å¼¹çª—
      function switchLanguagePopUp() {
        document.getElementById("myModal").style.display = "block";
      }
      // ä¸­å¥–æ¦‚ç‡è¡¨æ ¼å¼¹çª—
      function switchProbabilityTable() {
        if (document.getElementById("myProbabilityTable").style.display == "block") {
          document.getElementById("myProbabilityTable").style.display = "none";
        } else {
          document.getElementById("myProbabilityTable").style.display = "block";
        }
      }
      // å…‘å¥–äºŒç»´ç å¼¹çª—
      function displayQrcode(uuid, name, qrCodePopup) {
        if (name === "No Prize") {
          alert(lang.includes('zh') ? "æœªä¸­å¥–ï¼" : "No Prize!");
          return;
        }
        let nameElement = document.getElementById("codeName");
        nameElement.textContent = name;
        $('#qrcode').qrcode(uuid);
        qrCodePopup.style.display = "grid";
      }
      function closeQrcode() {
        document.getElementById("codeArea").innerHTML = ""; // ç§»é™¤å½“å‰äºŒç»´ç å…ƒç´ 
        let qrcode = document.createElement("div"); // é‡æ–°æ„å»ºäºŒç»´ç å®¹å™¨
        qrcode.id = "qrcode";
        document.getElementById("codeArea").appendChild(qrcode);
        document.getElementById("myQRCode").style.display = "none";
      }

      // Rule3&4è·å–æœºä¼šäºŒç»´ç å¼¹çª—
      function showTokenCode() {
        let tokenCodePopup = document.getElementById("myTokenQR");
        $('#tokenCode').qrcode(token);
        tokenCodePopup.style.display = "grid";
      }
      function closeTokenCode() {
        document.getElementById("tokenCodeArea").innerHTML = ""; // ç§»é™¤å½“å‰äºŒç»´ç å…ƒç´ 
        let qrcode = document.createElement("div"); // é‡æ–°æ„å»ºäºŒç»´ç å®¹å™¨
        qrcode.id = "tokenCode";
        document.getElementById("tokenCodeArea").appendChild(qrcode);
        document.getElementById("myTokenQR").style.display = "none";
        getChance();
      }
      // =====================å…¨å±€å˜é‡=====================
      var turnplate = {
        restaraunts: [], //å¤§è½¬ç›˜å¥–å“åç§°
        colors: [], //å¤§è½¬ç›˜å¥–å“åŒºå—å¯¹åº”èƒŒæ™¯é¢œè‰²
        outsideRadius: 192, //å¤§è½¬ç›˜å¤–åœ†çš„åŠå¾„
        textRadius: 155, //å¤§è½¬ç›˜å¥–å“ä½ç½®è·ç¦»åœ†å¿ƒçš„è·ç¦»
        insideRadius: 68, //å¤§è½¬ç›˜å†…åœ†çš„åŠå¾„
        startAngle: 0, //å¼€å§‹è§’
        bRotate: false, //false:åœæ­¢;ture:æ—‹è½¬
      };
      var chanceNum = 0; //æŠ½å¥–æ¬¡æ•°
      var luckyNum = 0; //å¹¸è¿å€¼=å·²æŠ½å¥–æ¬¡æ•°*15
      var prizeList = new Array();
      var winPrizeIndex = -1;
      var resultList = [];
      var chance = Object;

      // =====================æ¥å£è°ƒç”¨=====================
      function addChancebyRule0() {
        alert(lang.includes('en') ? "Already got it!" : "å·²ç»é¢†å–è¿‡äº†ï¼");
      }
      function addChanceRule1() {
        $.ajax({
          url: prefix+"/lottery/addChancebyRule1",
          type: "GET",
          dataType: "json",
          timeout: 8000,
          headers: {
            Token: token,
          },
          success: function (response) {
            console.log(response);
            if (response.code == 0) {
              alert(response.msg);
            } else {
              alert("ğŸ‰Successfully added" + response.data + "chance(s)");
                      getChance();
            }
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
      }
      function addChanceRule2() {
        $.ajax({
          url: prefix+"/lottery/addChancebyRule2",
          type: "GET",
          dataType: "json",
          timeout: 8000,
          headers: {
            Token: token,
          },
          success: function (response) {
            console.log(response);
            if (response.code == 0) {
              alert(response.msg);
            } else {
              alert("ğŸ‰Successfully added!");
              getChance();
            }
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
      }
      function getChance() {
        $.ajax({
          url: prefix+"/lottery/getChance",
          type: "GET",
          dataType: "json",
          timeout: 8000,
          headers: {
            Token: token,
          },
          success: function (response) {
            chance = response.data;
            showChanceInfo();
            showRuleInfo();
          },
          error: function (response) {
            alert("Network request failure!");
          }
        });
        function showChanceInfo() {
          // è·å–è¦å±•ç¤ºå˜é‡å€¼çš„å…ƒç´ 
          let chanceNumElement = document.getElementById("chanceNum");
          let luckyNumElement = document.getElementById("luckyNum");
          chanceNum = chance.chance;
          luckyNum = chance.turn * 15;
          // å°†å˜é‡å€¼æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
          chanceNumElement.textContent = chanceNum;
          luckyNumElement.textContent = luckyNum;
        }
        function showRuleInfo() {
          let rule0Element = document.getElementById("rule0Num");
          let rule1Element = document.getElementById("rule1Num");
          let rule2Element = document.getElementById("rule2Num");
          let rule3Element = document.getElementById("rule3Num");
          let rule4Element = document.getElementById("rule4Num");
          let text = "";
          text = chance.rule0 + "/1";
          rule0Element.textContent = text;
          text = chance.rule1 + "/3";
          rule1Element.textContent = text;
          text = chance.rule2 + "/1";
          rule2Element.textContent = text;
          text = chance.rule3 + "/1";
          rule3Element.textContent = text;
          text = chance.rule4 + "/1";
          rule4Element.textContent = text;
        }
      }

      function getLotteryResult() {
        $.ajax({
          url: prefix+"/lottery/getUserPrizeResult",
          type: "GET",
          dataType: "json",
          timeout: 8000,
          headers: {
            Token: token,
          },
          success: function (response) {
            console.log(response);
            resultList = response.data;
            showResult();
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
        // åŠ¨æ€æ¸²æŸ“åˆ—è¡¨
        function showResult() {
          var resultElement = document.getElementById("resultList");
          resultElement.innerHTML = ""; // æ¸…ç©ºåˆ—è¡¨
          var fragment = document.createDocumentFragment(); // åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ç‰‡æ®µ
          // éå†æ•°ç»„, åŠ¨æ€æ¸²æŸ“åˆ—è¡¨
          resultList.forEach(element => {
            if (element.prizeName === "No Prize") {
                return;
            }
            // åˆ›å»ºåˆ—è¡¨é¡¹
            let listItem = document.createElement("mdui-list-item");
            listItem.onclick = function () {
              var qrCodePopup = document.getElementById("myQRCode");
              if (qrCodePopup.style.display !== "grid") { // äºŒç»´ç å¼¹çª—å·²æ‰“å¼€æ—¶ï¼Œé˜»æ­¢æ‰“å¼€æ–°äºŒç»´ç å¼¹çª—
                displayQrcode(element.uuid, element.prizeName, qrCodePopup)
              };
            };
            // åˆ›å»ºåˆ—è¡¨å†…å®¹-åç§°
            let resultName = document.createElement("span");
            resultName.style.fontSize = "14px";
            resultName.style.fontWeight = "normal";
            resultName.textContent = element.prizeName;
            // åˆ›å»ºåˆ—è¡¨å†…å®¹-æ—¶é—´
            let resultTime = document.createElement("span");
            resultTime.slot = "description";
            resultTime.style.fontSize = "12px";
            resultTime.style.fontWeight = "lighter";
            // æ—¶é—´ + 8å°æ—¶
            element.time = new Date(element.time);
            resultTime.textContent = new Date(element.time).toLocaleString();
            // ç»„è£…åˆ—è¡¨é¡¹
            listItem.appendChild(resultName);
            listItem.appendChild(resultTime);
            // å°†åˆ—è¡¨é¡¹æ·»åŠ åˆ°æ–‡æ¡£ç‰‡æ®µä¸­
            fragment.appendChild(listItem);

            // åˆ›å»ºåˆ†å‰²çº¿
            let divider = document.createElement("mdui-divider");
            // å°†åˆ†å‰²çº¿æ·»åŠ åˆ°æ–‡æ¡£ç‰‡æ®µä¸­
            fragment.appendChild(divider);
          });
          resultElement.appendChild(fragment); // å°†æ–‡æ¡£ç‰‡æ®µä¸€æ¬¡æ€§æ·»åŠ åˆ°é¡µé¢ä¸­
        }
      }

      function getPrizeList() {
        $.ajax({
          url: prefix+"/lottery/getPrizeList",
          type: "GET",
          async: false,
          dataType: "json",
          timeout: 8000,
          headers: {
            Token: token,
          },
          success: function (response) {
            if (response.code == 0) {
              alert(response.msg);
            }
            prizeList.push("No Prize");
            response.data.forEach(element => {
              prizeList.push(element.name);
            });
            console.log(prizeList);
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
      }

      function startDraw() {
        $.ajax({
          url: prefix+"/lottery/draw",
          type: "GET",
          dataType: "json",
          timeout: 8000,
          async: false,
          headers: {
            Token: token,
          },
          success: function (response) {
            if (response.code == 0) {
              alert(response.msg);
            }
            console.log(response);
            winPrizeIndex = prizeList.indexOf(response.data.prizeName);
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
      }

      // =====================ç»˜åˆ¶è½¬ç›˜=====================
      $(document).ready(function () {
        // æ‰“å¼€é¡µé¢æ—¶åŠ è½½å½“å‰å¥–æ± ï¼Œå¹¶è·å–ç”¨æˆ·æŠ½å¥–æœºä¼šä¿¡æ¯
        getChance();
        getPrizeList();
        getLotteryResult()

        //åŠ¨æ€æ·»åŠ å¤§è½¬ç›˜çš„å¥–å“ä¸å¥–å“åŒºåŸŸèƒŒæ™¯é¢œè‰²
        if (prizeList.length <= 0) { // è‹¥å¥–å“å…¨è¢«æŠ½å®Œ
          alert("æ— å‰©ä½™å¥–å“!");
          return;
        }
        turnplate.restaraunts = prizeList;
        turnplate.colors = [
          "#B9E576",
          "#52B5B5",
          "#B9E576",
          "#52B5B5",
          "#B9E576",
          "#52B5B5",
        ];

        //æ—‹è½¬è½¬ç›˜ item:å¥–å“ä½ç½®; txtï¼šæç¤ºè¯­;
        var rotateFn = function (item, txt) {
          var angles =
            item * (360 / turnplate.restaraunts.length) -
            360 / (turnplate.restaraunts.length * 2);
          if (angles < 270) {
            angles = 270 - angles;
          } else {
            angles = 360 - angles + 270;
          }
          $("#wheelcanvas").stopRotate();
          $("#wheelcanvas").rotate({
            angle: 0,
            animateTo:  angles + 3600, //æ—‹è½¬è§’åº¦
            duration: 6000, //æ—‹è½¬åŠ¨ç”»æ—¶é—´
            callback: function () {
              //ä¸­å¥–æç¤º
              if (lang.includes('zh')) {
                alert("ğŸ‰è·å¾—å¥–å“ï¼š" + txt + "!");
              } else {
                alert("ğŸ‰You won the prizeï¼š" + txt + "!");
              }
              // åˆ·æ–°ç”¨æˆ·æŠ½å¥–æœºä¼šä»¥åŠä¸­å¥–ç»“æœ
              getChance();
              getLotteryResult();
              turnplate.bRotate = !turnplate.bRotate;
            },
          });
        };

        $(".pointer").click(function () {
          //æŒ‡é’ˆç‚¹å‡»äº‹ä»¶
          if (turnplate.bRotate) return; //è¿‡æ»¤è½¬ç›˜æ­£åœ¨æ—‹è½¬ä¸­å‘ç”Ÿçš„ç‚¹å‡»äº‹ä»¶
          startDraw();
          //winPrizeIndex = 5;
          console.log(winPrizeIndex);
          turnplate.bRotate = !turnplate.bRotate;
          rotateFn(winPrizeIndex + 1, prizeList[winPrizeIndex]);
        });
      });

      //é¡µé¢æ‰€æœ‰å…ƒç´ åŠ è½½å®Œæ¯•åæ‰§è¡ŒdrawRouletteWheel()æ–¹æ³•å¯¹è½¬ç›˜è¿›è¡Œæ¸²æŸ“
      window.onload = function () {
        drawRouletteWheel();
      };

      function drawRouletteWheel() {
        var canvas = document.getElementById("wheelcanvas");
        if (canvas.getContext) {
          //æ ¹æ®å¥–å“ä¸ªæ•°è®¡ç®—åœ†å‘¨è§’åº¦
          var arc = Math.PI / (turnplate.restaraunts.length / 2);
          var ctx = canvas.getContext("2d");
          //åœ¨ç»™å®šçŸ©å½¢å†…æ¸…ç©ºä¸€ä¸ªçŸ©å½¢
          ctx.clearRect(0, 0, 422, 422);
          //strokeStyle å±æ€§è®¾ç½®æˆ–è¿”å›ç”¨äºç¬”è§¦çš„é¢œè‰²ã€æ¸å˜æˆ–æ¨¡å¼
          ctx.strokeStyle = "#FFFFFF";
          ctx.lineWidth = 3;
          //font å±æ€§è®¾ç½®æˆ–è¿”å›ç”»å¸ƒä¸Šæ–‡æœ¬å†…å®¹çš„å½“å‰å­—ä½“å±æ€§
          ctx.font = "16px Microsoft YaHei";
          for (var i = 0; i < turnplate.restaraunts.length; i++) {
            var angle = turnplate.startAngle + i * arc;
            ctx.fillStyle = turnplate.colors[i];
            ctx.beginPath();
            //arc(x,y,r,èµ·å§‹è§’,ç»“æŸè§’,ç»˜åˆ¶æ–¹å‘) æ–¹æ³•åˆ›å»ºå¼§/æ›²çº¿ï¼ˆç”¨äºåˆ›å»ºåœ†æˆ–éƒ¨åˆ†åœ†ï¼‰
            ctx.arc(
              // ç»˜åˆ¶å¤–åœˆåœ†å¼§
              211,
              211,
              turnplate.outsideRadius,
              angle,
              angle + arc,
              false
            );
            ctx.arc(211, 211, turnplate.insideRadius, angle + arc, angle, true); // ç»˜åˆ¶å†…åœˆåœ†å¼§
            ctx.stroke();
            ctx.fill();
            //é”ç”»å¸ƒ(ä¸ºäº†ä¿å­˜ä¹‹å‰çš„ç”»å¸ƒçŠ¶æ€)
            ctx.save();

            //----ç»˜åˆ¶å¥–å“å¼€å§‹----
            ctx.fillStyle = "#E5302F";
            var text = turnplate.restaraunts[i];
            var line_height = 20;
            //translateæ–¹æ³•é‡æ–°æ˜ å°„ç”»å¸ƒä¸Šçš„ (0,0) ä½ç½®
            ctx.translate(
              211 + Math.cos(angle + arc / 2) * turnplate.textRadius,
              211 + Math.sin(angle + arc / 2) * turnplate.textRadius
            );

            //rotateæ–¹æ³•æ—‹è½¬å½“å‰çš„ç»˜å›¾
            ctx.rotate(angle + arc / 2 + Math.PI / 2);

            /** ç»˜åˆ¶å¥–å“åç§°**/
            if (text.includes(" ")) { //å¥–å“åç§°ä¸­åŒ…å«ç©ºæ ¼ï¼Œåˆ™æŒ‰ç©ºæ ¼æ¢è¡Œç»˜åˆ¶
              var texts = text.split(" ");
              for (var j = 0; j < texts.length; j++) {
                ctx.fillText(
                  texts[j],
                  -ctx.measureText(texts[j]).width / 2,
                  j * line_height
                );
              }
            } else {
              //åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶å¡«è‰²çš„æ–‡æœ¬ã€‚æ–‡æœ¬çš„é»˜è®¤é¢œè‰²æ˜¯é»‘è‰²
              //measureText()æ–¹æ³•è¿”å›åŒ…å«ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«ä»¥åƒç´ è®¡çš„æŒ‡å®šå­—ä½“å®½åº¦
              ctx.font = "bold 20px Microsoft YaHei";
              ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
            }

            //æŠŠå½“å‰ç”»å¸ƒè¿”å›ï¼ˆè°ƒæ•´ï¼‰åˆ°ä¸Šä¸€ä¸ªsave()çŠ¶æ€ä¹‹å‰
            ctx.restore();
            //----ç»˜åˆ¶å¥–å“ç»“æŸ----
          }
        }
      }
    </script>
  </body>
</html>