<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lottery</title>

    <link href="static/css/zzsc.css" rel="stylesheet" type="text/css" />
    <link href="static/css/pop-ups.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/mdui@2.0.3/mdui.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      .container {
        margin: 0 auto;
      }

      .content {
        position: absolute;
        width: 100%;
        height: auto;
        margin: 0px auto;
        margin-top: 58%;
      }
    </style>
  </head>

  <body>
    <img
      src="static/picture/game-bg-zh.png"
      alt="background"
      class="zh bg"
    />
    <img
      src="static/picture/game-bg-en.png"
      alt="background"
      class="en bg"
    />

      <mdui-icon onclick="switchLanguagePopUp()"
        name="language"
        style="
          position: fixed;
          font-size: 30px;
          margin-top: 15px;
          margin-right: 15px;
          left: 85%;
          color: rgb(235, 248, 253);
        "
      ></mdui-icon>

    <div class="content" style="margin-top: 60%">
      <div class="banner">
        <!--抽奖转盘-->
        <div
          class="turnplate"
          style="
            background-image: url(static/image/turnplate-bg.png);
            background-size: 100% 100%;
          "
        >
          <canvas
            class="item"
            id="wheelcanvas"
            width="422px"
            height="422px"
          ></canvas>
          <img class="pointer" src="static/picture/turnplate-pointer.png" />
        </div>
        <mdui-icon name='info' style="font-size: 26px; color: rgb(104, 15, 219);" onclick="switchProbabilityTable()"> </mdui-icon>
        <!--抽奖次数&幸运值-->
        <mdui-list
          style="
            margin-top: 2%;
            background-color: #fde3cd;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-item>
            <p class="zh" style="font-weight: bold">抽奖机会</p>
            <p class="en" style="font-weight: bold">Chance</p>
            <p
              slot="end-icon"
              id="chanceNum"
              style="font-weight: bold; font-size: large"
            ></p>
          </mdui-list-item>
          <mdui-list-item>
            <p class="zh" style="font-weight: bold">幸运值</p>
            <p class="en" style="font-weight: bold">Lucky Level</p>
            <p
              slot="end-icon"
              id="luckyNum"
              style="font-weight: bold; font-size: large"
            ></p>
          </mdui-list-item>
        </mdui-list>

        <!--查看详细抽奖规则&中奖概率&中奖查询-->
        <div style="justify-content: center">
          <mdui-button
            style="margin-top: 5%; left: 10%; width: 100px;"
            onclick="switchRuleDetail()"
            >
            <p class="zh">抽奖规则</p>
            <p class="en">Rules</p>
          </mdui-button>
          <mdui-button onclick="getLotteryResult()" style="margin-top: 5%; left: 17%; width: 100px;">
            <p class="zh">中奖查询</p>
            <p class="en">Result Query</p>
          </mdui-button>
        </div>

        <!--获得抽奖机会-->
        <mdui-list
          style="
            margin-top: 2%;
            background-color: #fae7d6;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-subheader style="font-size: larger; font-weight: bold">
            <p class="zh">获得抽奖机会</p>
            <p class="en">Get Chance</p>
          </mdui-list-subheader
          >
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">1、安装软件</p>
            <p class="en" style="font-weight: lighter; font-size: small">1、Install Xplorer</p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChancebyRule0()"
            >
              <p id="rule0Num"></p>
            </mdui-button>
          </mdui-list-item>
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">
              2、邀请4位同学注册
            </p>
            <p class="en" style="font-weight: lighter; font-size: small">
              2、Invite 4 friends to register
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChanceRule1()"
            >
              <p id="rule1Num"></p>
            </mdui-button>
          </mdui-list-item>
          <mdui-list-item>
            <p class="zh" style="font-weight: lighter; font-size: small">
              3、参与食堂评价
            </p>
            <p class="en" style="font-weight: lighter; font-size: small">
              3、 Participate in Canteen Vote
            </p>
            <mdui-button
              slot="end-icon"
              style="height: 30px; background-color: #ff8765"
              onclick="addChanceRule2()"
            >
              <p id="rule2Num"></p>
            </mdui-button>
          </mdui-list-item>
        </mdui-list>

        <!--中奖记录展示-->
        <mdui-list 
          style="
            margin-top: 5%;
            background-color: #fae7d6;
            border-radius: 20px;
            padding: 15px;
          "
        >
          <mdui-list-subheader style="font-size: larger; font-weight: bold">
            <p class="zh">中奖记录</p>
            <p class="en">Result</p>
          </mdui-list-subheader>
          <div id="resultList"></div>
        </mdui-list>
      </div>
    </div>

    <!-- 抽奖规则弹窗 -->
    <div id="myRuleDetail" class="ruleDetail">
      <div class="zh">
        <h2>抽奖规则：</h2>
        <p>1、安装软件获得1次抽奖机会</p>
        <p>
          2、每邀请4位同学安装并注册软件，获得1次抽奖机会（最多可获得3次抽奖机会）
        </p>
        <p>3、参与食堂打分可获得1次抽奖机会（最多可获得1次抽奖机会）</p>
        <p style="margin-top: 5px;">*：若抽奖但是没有中奖，则将积累幸运值提升下次抽奖的中奖概率，幸运值将会在下次中奖后重置</p>
        <h2 style="margin-top: 10px">兑奖规则：</h2>
        <p style="margin-bottom: 5px">
          消耗抽奖次数进行抽奖后，若中奖，则会产生中奖记录并保存。
        </p>
        <p>用户前往活动摊位凭中奖记录二维码兑换相应奖品。</p>
        <p style="margin-top: 20px; font-weight: lighter; font-size: 12px;">注：本活动与苹果公司无关</p>
      </div>
      <div class="en">
        <h2>Rules：</h2>
        <p>1、Install Xplorer and get 1 lucky draw chance</p>
        <p>
          2、Every 4 students you invite to install and register Xplorer will get 1 lucky draw chance (Maximum 3 lucky draw chances)
        </p>
        <p>3、Participate in Canteen Vote to get 1 lucky draw chance (Maximum 1 lucky draw chance)</p>
        <p style="margin-top: 5px;">
          *：If you draw but do not win, the Lucky Level will be accumulated to increase the probability of winning the next draw. The Lucky Level will be reset after the next winning.
        </p>
        <h2 style="margin-top: 10px">Prize redemption rules：</h2>
        <p style="margin-bottom: 5px">
          After consuming the chances of lottery draws, if you win, a winning record will be generated and saved.
        </p>
        <p>Users go to the event booth to redeem corresponding prizes based on the QR codes of winning records.</p>
        <p style="margin-top: 20px; font-weight: lighter; font-size: 12px;">
          Note: This event has nothing to do with Apple Inc.
        </p>
      </div>
      <mdui-button onclick="switchRuleDetail()" style="margin-top: 10px; left: 70%; height: 35px">
        <p class="zh">懂啦 !</p>
        <p class="en">Get it !</p>
      </mdui-button>
    </div>

    <!--奖品概率表格弹窗-->
    <div id="myProbabilityTable" class="probabilityTable">
      <table>
        <tr>
          <th>Extraction Times</th>
          <th>First Extraction</th>
          <th>Second Extraction</th>
          <th>Third Extraction</th>
          <th>Fourth Extraction</th>
          <th>Fifth Extraction</th>
        </tr>
        <tr>
          <td>Under the Big Tree</td>
          <td>2.00%</td>
          <td>10.00%</td>
          <td>20.00%</td>
          <td>30.00%</td>
          <td>30.00%</td>
        </tr>
        <tr>
          <td>Penang</td>
          <td>40.00%</td>
          <td>30.00%</td>
          <td>25.00%</td>
          <td>20.00%</td>
          <td>20.00%</td>
        </tr>
        <tr>
          <td>Postcard</td>
          <td>8.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Red Envelope</td>
          <td>5.00%</td>
          <td>5.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Bookmark</td>
          <td>5.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Envelope</td>
          <td>5.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
          <td>10.00%</td>
        </tr>
        <tr>
          <td>Total Probability</td>
          <td>65.00%</td>
          <td>75.00%</td>
          <td>85.00%</td>
          <td>90.00%</td>
          <td>90.00%</td>
        </tr>
      </table>
      <mdui-button onclick="switchProbabilityTable()" style="margin-top: 10px; left: 70%; height: 35px; position: sticky;">
        <p class="zh">懂啦 !</p>
        <p class="en">Get it !</p>
      </mdui-button>
    </div>

    <!-- 语言选择弹窗 -->
    <div id="myModal" class="modal">
      <p style="margin-bottom: 15px; font-weight: bold">
        Please select language:
      </p>
      <mdui-button
        class="btn"
        onclick="selectLanguage('en')"
        style="width: 40%; margin: 0 10px"
        >English</mdui-button
      >
      <mdui-button class="btn" onclick="selectLanguage('zh')" style="width: 40%"
        >鬃纹</mdui-button
      >
    </div>

    <!--兑奖二维码弹窗-->
    <div id="myQRCode" class="QRCode">
      <div id="codeArea">
        <div id="qrcode" style="justify-content: center; display: grid;"></div>
      </div>
      <mdui-button onclick="closeQrcode()" style="margin-top: 10px; height: 35px">
        <p class="zh">好啦 !</p>
        <p class="en">Finish !</p>
      </mdui-button>
    </div>

    <script src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/awardRotate.js"></script>
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script type="text/javascript">

      // =====================网页初始化=====================
      // 测试用：?token=eyJhbGciOiJIUzI1NiJ9.eyJ1aWQiOjQsImlkIjo0LCJleHAiOjE3Mzk3MzExOTd9.ZyOuV7D84HcUOovdXJfZTWnxdWl9Lk5SIasBRqqGG5I&lang=en
      // 拦截非法访问，获取token和language
      const url = new URL(window.location.href);
      if (!(url.href.includes("token") && url.href.includes("lang"))) { // 非法访问则重定向至官网
        window.location.href = "https://www.mocd.cc/";
      }
      const token = url.searchParams.get("token");
      var lang = url.searchParams.get("lang");

      // =====================多语言调节=====================
      // 语言调整函数
      function switchLanguage() {
        if (lang.includes("en")) {
          var enElements = document.getElementsByClassName("en");
          var zhElements = document.getElementsByClassName("zh");
          for (var i = 0; i < enElements.length; i++) {
            enElements[i].style.display = "block";
            zhElements[i].style.display = "none";
          }
        } else if (lang.includes("zh")) {
          var enElements = document.getElementsByClassName("en");
          var zhElements = document.getElementsByClassName("zh");
          for (var i = 0; i < enElements.length; i++) {
            zhElements[i].style.display = "block";
            enElements[i].style.display = "none";
          }
        }
      }
      // 自动选择语言
      $(document).ready(function () {
        switchLanguage();
      });
      // 语言选择按钮
      function selectLanguage(choseLang) {
        lang = choseLang;
        switchLanguage();
        document.getElementById("myModal").style.display = "none";
      }

      // =====================弹窗控制=====================
      // 抽奖规则弹窗
      function switchRuleDetail() {
        if (document.getElementById("myRuleDetail").style.display == "block") {
          document.getElementById("myRuleDetail").style.display = "none";
        } else {
          document.getElementById("myRuleDetail").style.display = "block";
        }
      }
      // 语言选择弹窗
      function switchLanguagePopUp() {
        document.getElementById("myModal").style.display = "block";
      }
      // 中奖概率表格弹窗
      function switchProbabilityTable() {
        if (document.getElementById("myProbabilityTable").style.display == "block") {
          document.getElementById("myProbabilityTable").style.display = "none";
        } else {
          document.getElementById("myProbabilityTable").style.display = "block";
        }
      }
      // 兑奖二维码弹窗
      function displayQrcode(uuid) {
        var qrCodePopup = document.getElementById("myQRCode");
        if (qrCodePopup.style.display !== "grid") { // 二维码弹窗已打开时，阻止打开新二维码弹窗
          $('#qrcode').qrcode(uuid);
          qrCodePopup.style.display = "grid";
        }
      }
      function closeQrcode() {
        document.getElementById("codeArea").innerHTML = ""; // 移除当前二维码元素
        let qrcode = document.createElement("div"); // 重新构建二维码容器
        qrcode.id = "qrcode";
        document.getElementById("codeArea").appendChild(qrcode);
        document.getElementById("myQRCode").style.display = "none";
      }

      // =====================全局变量=====================
      var turnplate = {
        restaraunts: [], //大转盘奖品名称
        colors: [], //大转盘奖品区块对应背景颜色
        outsideRadius: 192, //大转盘外圆的半径
        textRadius: 155, //大转盘奖品位置距离圆心的距离
        insideRadius: 68, //大转盘内圆的半径
        startAngle: 0, //开始角
        bRotate: false, //false:停止;ture:旋转
      };
      var chanceNum = 0; //抽奖次数
      var luckyNum = 0; //幸运值=已抽奖次数*15
      var prizeList = new Array();
      var winPrizeIndex = -1;
      var resultList = [];
      var chance = Object;

      // =====================接口调用=====================
      function addChancebyRule0() {
        alert("已领取1次机会，到达上限！");
      }
      function addChanceRule1() {
        $.ajax({
          url: "https://api.xmum.app/lottery/addChancebyRule1",
          type: "GET",
          dataType: "json",
          headers: {
            Token: token,
          },
          success: function (response) {
            console.log(response);
            if (response.code == 0) {
              alert(response.msg);
            } else {
              alert("Successfully added!");
            }
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
        getChance();
      }
      function addChanceRule2() {
        $.ajax({
          url: "https://api.xmum.app/lottery/addChancebyRule2",
          type: "GET",
          dataType: "json",
          headers: {
            Token: token,
          },
          success: function (response) {
            console.log(response);
            if (response.code == 0) {
              alert(response.msg);
            } else {
              alert("Successfully added!");
            }
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
        getChance();
      }
      function getChance() {
        $.ajax({
          url: "https://api.xmum.app/lottery/getChance",
          type: "GET",
          dataType: "json",
          headers: {
            Token: token,
            // "Content-Type": "application/json",
          },
          success: function (response) {
            chance = response.data;
            showChanceInfo();
            showRuleInfo();
          },
          error: function (response) {
            alert("Network request failure!");
          }
        });
        function showChanceInfo() {
          // 获取要展示变量值的元素
          let chanceNumElement = document.getElementById("chanceNum");
          let luckyNumElement = document.getElementById("luckyNum");
          chanceNum = chance.chance;
          luckyNum = chance.turn * 15;
          // 将变量值显示在页面上
          chanceNumElement.textContent = chanceNum;
          luckyNumElement.textContent = luckyNum;
        }
        function showRuleInfo() {
          let rule0Element = document.getElementById("rule0Num");
          let rule1Element = document.getElementById("rule1Num");
          let rule2Element = document.getElementById("rule2Num");
          let text = "";
          text = chance.rule0 + "/1";
          rule0Element.textContent = text;
          text = chance.rule1 + "/3";
          rule1Element.textContent = text;
          text = chance.rule2 + "/1";
          rule2Element.textContent = text;
        }
      }

      function getLotteryResult() {
        $.ajax({
          url: "https://api.xmum.app/lottery/getUserPrizeResult",
          type: "GET",
          dataType: "json",
          headers: {
            Token: token,
          },
          success: function (response) {
            console.log(response);
            resultList = response.data;
            showResult();
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
        function showResult() { // 动态渲染列表
          // var date = new Date(resultList[0].time);
          // date = date.setHours(date.getHours() + 8);
          // console.log(date.toLocaleDateString);

          var resultElement = document.getElementById("resultList");
          resultElement.innerHTML = ""; // 清空列表
          var fragment = document.createDocumentFragment(); // 创建一个文档片段
          // 遍历数组, 动态渲染列表
          resultList.forEach(element => {
            let resultPrizeName = document.createElement("mdui-list-item");
            resultPrizeName.onclick = function () { //点击显示兑奖二维码
              displayQrcode(element.uuid);
            };
            resultPrizeName.textContent = element.prizeName;
            let resultTime = document.createElement("span");
            resultTime.slot = "description";
            resultTime.textContent = element.time.slice(0, 10) + " " + element.time.slice(11, 19);
            resultPrizeName.appendChild(resultTime);

            fragment.appendChild(resultPrizeName); // 将列表项添加到文档片段中

            let divider = document.createElement("mdui-divider");
            fragment.appendChild(divider);
          });
          resultElement.appendChild(fragment); // 将文档片段一次性添加到页面中
        }
      }

      function getPrizeList() {
        $.ajax({ // TODO: Timeout
          url: "https://api.xmum.app/lottery/getPrizeList",
          type: "GET",
          async: false,
          dataType: "json",
          headers: {
            Token: token,
          },
          success: function (response) {
            prizeList.push("No Prize");
            response.data.forEach(element => {
              prizeList.push(element.name);
            });
            console.log(prizeList);
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
      }

      function startDraw() {
        $.ajax({
          url: "https://api.xmum.app/lottery/draw",
          type: "GET",
          dataType: "json",
          async: false,
          headers: {
            Token: token,
          },
          success: function (response) {
            console.log(response);
            winPrizeIndex = prizeList.indexOf(response.data.prizeName);
          },
          error: function (response) {
            alert("Network request failure!");
          },
        });
        getChance();
        getLotteryResult();
      }

      // =====================绘制转盘=====================
      $(document).ready(function () {
        // 打开页面时加载当前奖池，并获取用户抽奖机会信息
        getChance();
        getPrizeList();

        //动态添加大转盘的奖品与奖品区域背景颜色
        if (prizeList.length <= 0) { // 若奖品全被抽完
          alert("无剩余奖品!");
          return;
        }
        turnplate.restaraunts = prizeList;
        turnplate.colors = [
          "#B9E576",
          "#008080",
          "#209B87",
          "#4DB686",
          "#80CF7F",
          "#B9E576",
          "#F9F871",
        ];

        //旋转转盘 item:奖品位置; txt：提示语;
        var rotateFn = function (item, txt) {
          var angles =
            item * (360 / turnplate.restaraunts.length) -
            360 / (turnplate.restaraunts.length * 2);
          if (angles < 270) {
            angles = 270 - angles;
          } else {
            angles = 360 - angles + 270;
          }
          $("#wheelcanvas").stopRotate();
          $("#wheelcanvas").rotate({
            angle: 0,
            animateTo:  angles + 3600, //旋转角度
            duration: 6000, //旋转动画时间
            callback: function () {
              //中奖提示
              alert("获得奖品：" + txt);
              turnplate.bRotate = !turnplate.bRotate;
            },
          });
        };

        $(".pointer").click(function () {
          //指针点击事件
          if (turnplate.bRotate) return; //过滤转盘正在旋转中发生的点击事件
          startDraw();
          //winPrizeIndex = 5;
          console.log(winPrizeIndex);
          turnplate.bRotate = !turnplate.bRotate;

          rotateFn(winPrizeIndex + 1, prizeList[winPrizeIndex]);
        });
      });

      //页面所有元素加载完毕后执行drawRouletteWheel()方法对转盘进行渲染
      window.onload = function () {
        drawRouletteWheel();
      };

      function drawRouletteWheel() {
        var canvas = document.getElementById("wheelcanvas");
        if (canvas.getContext) {
          //根据奖品个数计算圆周角度
          var arc = Math.PI / (turnplate.restaraunts.length / 2);
          var ctx = canvas.getContext("2d");
          //在给定矩形内清空一个矩形
          ctx.clearRect(0, 0, 422, 422);
          //strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式
          ctx.strokeStyle = "#FFBE04";
          //font 属性设置或返回画布上文本内容的当前字体属性
          ctx.font = "16px Microsoft YaHei";
          for (var i = 0; i < turnplate.restaraunts.length; i++) {
            var angle = turnplate.startAngle + i * arc;
            ctx.fillStyle = turnplate.colors[i];
            ctx.beginPath();
            //arc(x,y,r,起始角,结束角,绘制方向) 方法创建弧/曲线（用于创建圆或部分圆）
            ctx.arc(
              // 绘制外圈圆弧
              211,
              211,
              turnplate.outsideRadius,
              angle,
              angle + arc,
              false
            );
            ctx.arc(211, 211, turnplate.insideRadius, angle + arc, angle, true); // 绘制内圈圆弧
            ctx.stroke();
            ctx.fill();
            //锁画布(为了保存之前的画布状态)
            ctx.save();

            //----绘制奖品开始----
            ctx.fillStyle = "#E5302F";
            var text = turnplate.restaraunts[i];
            var line_height = 20;
            //translate方法重新映射画布上的 (0,0) 位置
            ctx.translate(
              211 + Math.cos(angle + arc / 2) * turnplate.textRadius,
              211 + Math.sin(angle + arc / 2) * turnplate.textRadius
            );

            //rotate方法旋转当前的绘图
            ctx.rotate(angle + arc / 2 + Math.PI / 2);

            /** 绘制奖品名称**/
            if (text.length > 10) {
              //奖品名称长度超过一定范围
              text = text.substring(0, 10) + "||" + text.substring(10);
              var texts = text.split("||");
              for (var j = 0; j < texts.length; j++) {
                ctx.fillText(
                  texts[j],
                  -ctx.measureText(texts[j]).width / 2,
                  j * line_height
                );
              }
            } else {
              //在画布上绘制填色的文本。文本的默认颜色是黑色
              //measureText()方法返回包含一个对象，该对象包含以像素计的指定字体宽度
              ctx.font = "bold 20px Microsoft YaHei";
              ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
            }

            //把当前画布返回（调整）到上一个save()状态之前
            ctx.restore();
            //----绘制奖品结束----
          }
        }
      }
    </script>
  </body>
</html>
